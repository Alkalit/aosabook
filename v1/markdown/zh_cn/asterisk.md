#Asterisk

Russell Bryant

Asterisk<sup>1</sup>是一个开源的电话通讯应用软件平台，授权协议是GPLv2。简而言之，Asterisk就是一个打电话、接电话和对电话进行定制化处理的服务器端应用程序。

这个项目是由Mark Spencer在1999年启动的。Mark有一个公司叫Linux支持服务公司，他需要一个电话系统帮助他运营业务。他没钱去买一个系统，所以就自己做了一个。当Asterisk逐渐流行起来，Linux支持服务公司就把业务转向了Asterisk，并且把公司的名字改成Digium公司。

Asterisk这个名字来自Unix通配符，*。Asterisk项目的目标是能完成所有的电话通信事务。通过追求这个目标，Asterisk现在可以支持一长串接打电话的技术。这里面包括很多VoIP（Voice Over IP：网络电话技术）协议，也包括到传统电话网络的模拟和数字连接，或者到PSTN（Public Switched Telephone Network： 公用电话交换网）的连接。Asterisk的主要强项就是系统能够接打和拨出多种类型的电话。

一旦从Asterisk系统接到或拨出了电话，那么就用很多方式来处理这些电话。有些功能更加通用一些，例如语音信箱，这些功能就预制在系统里。也有其他的一些小功能可以组合在一起创建一个定制化的语音应用，例如回放声音文件、读出数字或语音识别等。

##1.1. 关键的架构概念

本节讨论一些架构上的概念，这些概念对于Asterisk的所有部分都很关键。这些概念是Asterisk架构的基础。

###1.1.1. 通道（Channels）

Asterisk中的通道表示Asterisk系统和一些电话通讯节点的连接（如图1.1所示）。最常见的例子是当一部电话接入Asterisk系统的时候。这个连接就是由一个单独的通道表示。在Asterisk代码里，一个通道就是ast_channel数据结构的一个实例。举个例子来说，这个呼叫场景可能是一个人正和语音信箱交互。

<div align="center"><img src="img/singleChannel.png"></div>
<div align="center">图1.1 由一个单通道表示的单个电话支路</div>

###1.1.2. 通道桥接

可能更熟悉的一种呼叫场景是两个电话之间的连接，就是一个人用电话A呼叫另一个人的电话B。在这种情况下，有两个电话通讯节点连接到Asterisk系统，所以这个呼叫存在两个通道（如图1.2所示）。

<div align="center"><img src="img/twoChannels.png"></div>
<div align="center">图1.2 由两个通道表示的两个电话支路</div>

像这样连接的Asterisk通道，我们称之为一个通道桥。通道桥接是为了传递媒体的目的把通道连接在一起的行为。媒体流通常情况下是音频流。然而，呼叫过程中也可能有视频或文字流。即使有多个媒体流（例如既有音频又有视频）存在，在Asterisk系统里都是由呼叫节点的一个单通道处理的。在图1.2中，电话A和电话B有两个通道，中间的桥负责把媒体从电话A传到电话B，同样，也把媒体从电话B传到电话A。所有的媒体流都要通过Asterisk进行协商。任何Asterisk所不能理解或不能完全控制的东西都是不允许的。这意味着Asterisk可以在不同的技术之间进行录音、音频处理和翻译。

如果需要把两个通道桥接在一起，有两种方法可以完成：通用桥接和本地桥接。通用桥接就是不管使用的是什么通道技术。它通过Asterisk抽象通道接口传递所有的音频和信令。虽然这是最灵活的桥接方法，但是这也是效率最低的，因为为了完成这个任务用了过多抽象层。图1.2给出了一个通用桥的例子。

本地桥是使用一种特定的技术把通道连接在一起的方法。如果连接到Asterisk上的两个通道使用的是同样的媒体传输技术，那么可能存在一种方法，可以比通过Asterisk中连接不同技术的多个抽象层的方法更有效率。例如，如果连接到电话网络的是特殊的硬件，那就可以把通道架设在硬件之上，这样的话媒体就完全不用经过应用程序了。对于VoIP协议来说，节点两端就可以直接互相发送媒体流，最后就只有呼叫信令继续在服务器上传送了。

选择通用桥接还是本地桥接，是在对两个通道进行桥接的时候决定的。如果两个通道表明支持同一种本地桥接方法，那么就会用本地桥接。否则，就使用通用桥接方法。为了确定两个通道是否支持同样的本地桥接方法，程序中使用了简单的C函数指针比较。这肯定不是最优雅的方式，但是我们还没有遇到效率上满足不了我们需要的场景。1.2节给出了提供本地桥接函数的更多细节的讨论。图1.3给出了一个本地桥接的例子。

<div align="center"><img src="img/nativeBridge.png"></div>
<div align="center">图1.3 本地桥接的例子</div>





















